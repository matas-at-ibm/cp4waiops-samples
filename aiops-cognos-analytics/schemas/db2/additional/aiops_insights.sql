

-------------------------------------------------------------------------------
--
-- Â© Copyright IBM Corp. 2026

-- This source code is licensed under the Apache-2.0 license found in the
-- LICENSE file in the root directory of this source tree.
--
-------------------------------------------------------------------------------
-- This script will create all the schema objects needed
-- to display aiops insights dashboard in cognos. This includes tables, views, procedures, triggers procedures.

-- To run this script, you must do the following:
--   (1) Put this script in directory of your choice.

--   (2) At the command prompt, run this script.

--       EXAMPLE:    db2 -td@ -vf c:	emp\db2iops-insights.sql
--------------------------------------------------------------------------------
--#SET TERMINATOR @





------------------------------------------------
-- Augment INCIDENTS_REPORTER_STATUS table to enable the containment of the alert Id data needed to make relationships between incidents and alerts
------------------------------------------------

ALTER TABLE INCIDENTS_REPORTER_STATUS ADD ALERTIDS CLOB@


------------------------------------------------
-- Augment ALERTS_REPORTER_STATUS table to enable the containment of the resource group data needed to make relationships between resource groups and alerts
------------------------------------------------

ALTER TABLE ALERTS_REPORTER_STATUS ADD RESOURCEGROUPIDS CLOB@

ALTER TABLE ALERTS_REPORTER_STATUS ADD RESOURCEGROUPDETAILS CLOB@


------------------------------------------------
-- DDL Statements for Table "PAST_HOURS"
------------------------------------------------

CREATE TABLE INCIDENT_PRIORITY_TYPES  (
	NAME CHAR(2),
	PRIORITY SMALLINT 
)@

INSERT INTO INCIDENT_PRIORITY_TYPES (NAME, PRIORITY) VALUES
	('P1', 1),
	('P2', 2),
	('P3', 3),
	('P4', 4),
	('P5', 5)@

------------------------------------------------
-- DDL Statements for Table "PAST_HOURS"
------------------------------------------------
 
CREATE TABLE PAST_HOURS  (
	ID SMALLINT NOT NULL, 
	HOUR SMALLINT,
	PRIMARY KEY (ID)
)@

INSERT INTO PAST_HOURS (ID, HOUR) VALUES
	 (1,0),
	 (2,1),
	 (3,2),
	 (4,3),
	 (5,4),
	 (6,5),
	 (7,6),
	 (8,7),
	 (9,8),
	 (10,9),
	 (11,10),
	 (12,11),
	 (13,12),
	 (14,13),
	 (15,14),
	 (16,15),
	 (17,16),
	 (18,17),
	 (19,18),
	 (20,19),
	 (21,20),
	 (22,21),
	 (23,22),
	 (24,23),
	 (25,24)@

COMMIT WORK@

------------------------------------------------
-- DDL Statements for Table "PAST_DAYS"
------------------------------------------------

CREATE TABLE PAST_DAYS  (
	ID SMALLINT NOT NULL, 
	DAY SMALLINT,
	PRIMARY KEY (ID)
)@

INSERT INTO PAST_DAYS (ID, DAY) VALUES
	 (1,0),
	 (2,1),
	 (3,2),
	 (4,3),
	 (5,4),
	 (6,5),
	 (7,6),
	 (8,7),
	 (9,8),
	 (10,9),
	 (11,10),
	 (12,11),
	 (13,12),
	 (14,13),
	 (15,14),
	 (16,15),
	 (17,16),
	 (18,17),
	 (19,18),
	 (20,19),
	 (21,20),
	 (22,21),
	 (23,22),
	 (24,23),
	 (25,24),
	 (26,25),
	 (27,26),
	 (28,27),
	 (29,28),
	 (30,29),
	 (31,30)@

COMMIT WORK@

------------------------------------------------
-- DDL Statements for Table "RESOURCE_GROUPS"
------------------------------------------------
 
CREATE TABLE RESOURCE_GROUPS  (
	UUID VARCHAR(255) NOT NULL , 
	NAME VARCHAR(255),
	PRIMARY KEY (UUID)
)@
--DATA CAPTURE NONE@


------------------------------------------------
-- DDL Statements for Table "RESOURCE_GROUP_SCOPES"
------------------------------------------------
 
CREATE TABLE RESOURCE_GROUP_SCOPES  (
		UUID INTEGER NOT NULL GENERATED ALWAYS AS IDENTITY (  
			START WITH +0  
			INCREMENT BY +1  
			MINVALUE +0  
			MAXVALUE +2147483647  
			NO CYCLE  
			CACHE 20  
			NO ORDER ) , 
		NAME VARCHAR(255) NOT NULL , 
		RESOURCEGROUPNAME VARCHAR(255) , 
		RESOURCEGROUPTAG VARCHAR(255) , 
		SCOPEID VARCHAR(255) NOT NULL WITH DEFAULT '' 
)@ 
--DATA CAPTURE NONE@

ALTER TABLE RESOURCE_GROUP_SCOPES ADD CONSTRAINT RESOURCE_GROUP_SCOPES_PK PRIMARY KEY (UUID) ENFORCED@

INSERT INTO RESOURCE_GROUP_SCOPES (NAME,RESOURCEGROUPNAME,RESOURCEGROUPTAG,SCOPEID) VALUES ('All Resources', NULL, NULL, 'All Resources')@

COMMIT WORK@

------------------------------------------------
-- DDL Statements for Table "RESOURCE_GROUP_TAGS"
------------------------------------------------


CREATE TABLE RESOURCE_GROUP_TAGS  (
	RESOURCEGROUPUUID VARCHAR(255) NOT NULL , 
	TAG VARCHAR(255) 
)@
--DATA CAPTURE NONE@

------------------------------------------------
-- DDL Statements for Table "RESOURCE_GROUP_ENTITYTYPES"
------------------------------------------------
 

CREATE TABLE RESOURCE_GROUP_ENTITYTYPES  (
	RESOURCEGROUPUUID VARCHAR(255) NOT NULL , 
	ENTITYTYPE VARCHAR(255)
)@ 
--DATA CAPTURE NONE@

------------------------------------------------
-- DDL Statements for Table "ALERTS_RESOURCE_GROUPS_RELATIONS"
------------------------------------------------
 

CREATE TABLE ALERTS_RESOURCE_GROUPS_RELATIONS  (
	ALERTUUID VARCHAR(255), 
	RESOURCEGROUPID VARCHAR(255) 
)@
--DATA CAPTURE NONE@

------------------------------------------------
-- DDL Statements for Table "INCIDENTS_ALERTS_RELATIONS"
------------------------------------------------
 

CREATE TABLE INCIDENTS_ALERTS_RELATIONS (
	INCIDENTUUID VARCHAR(255), 
	ALERTUUID VARCHAR(255) 
)@
--DATA CAPTURE NONE@

---------------------------------
-- DDL Statements for Stored Procedures
---------------------------------

CREATE PROCEDURE INCIDENTS_RELATIONS_UPDATE(IN tenantId VARCHAR(64), IN newIncidentId VARCHAR(255), IN alertIdsToAssociate CLOB)
LANGUAGE SQL
MODIFIES SQL DATA
BEGIN
	
	DECLARE currentAlertId VARCHAR(255);

	DECLARE lastAlertId VARCHAR(255);
	
	
	DELETE
	FROM
	      DB2INST1.INCIDENTS_ALERTS_RELATIONS
	WHERE
	      INCIDENTUUID = newIncidentId;
	
	
	WHILE (LOCATE(',', alertIdsToAssociate) > 0) DO 
		    SET
		currentAlertId = CONCAT(CONCAT(tenantId, '_'), CAST(SUBSTR(alertIdsToAssociate, 1, (LOCATE(',', alertIdsToAssociate) -1)) AS VARCHAR(255)));
		
		
		INSERT
		    INTO
		    DB2INST1.INCIDENTS_ALERTS_RELATIONS (INCIDENTUUID,
		    ALERTUUID)
		VALUES (newIncidentId,
		currentAlertId);
		
		
		SET
		alertIdsToAssociate = SUBSTR(alertIdsToAssociate, (LOCATE(',', alertIdsToAssociate) + 1));
		
	END WHILE;
	
	
	SET
	lastAlertId = CONCAT(CONCAT(tenantId, '_'), CAST(alertIdsToAssociate AS VARCHAR(255)));
	
	
	INSERT
	    INTO
	    DB2INST1.INCIDENTS_ALERTS_RELATIONS (INCIDENTUUID,
	    ALERTUUID)
	VALUES (newIncidentId,
	lastAlertId);

END@



CREATE PROCEDURE PROCESS_ALERT_RESOURCE_GROUP(IN newResourceGroupId VARCHAR(255), IN resourceGroupsDetails CLOB)
LANGUAGE SQL
MODIFIES SQL DATA
BEGIN
  DECLARE currrentResourceGroupName VARCHAR(255);
  DECLARE currrentResourceGroupEntityType VARCHAR(255);
  DECLARE currrentResourceGroupTag VARCHAR(255);

  -- Format of <resourceGroupsDetails>
  -- Service front-end-svc.myapp.example.com to service to database to hypervisor</*/>tag-1</-/>tag-2</*/>waiopsApplication</+/>resourceGroup
  
	SET currrentResourceGroupName = CAST(SUBSTR(resourceGroupsDetails, 1, (LOCATE('</*/>', resourceGroupsDetails) -1)) AS VARCHAR(255));
  INSERT INTO DB2INST1.RESOURCE_GROUPS (UUID, NAME)
  VALUES (newResourceGroupId, currrentResourceGroupName);

  -- remove the name part from resourceGroupsDetails
	SET resourceGroupsDetails = SUBSTR(resourceGroupsDetails, (LOCATE('</*/>', resourceGroupsDetails) + 5));

  -- iterate through the tags in the details
	WHILE (LOCATE('</-/>', resourceGroupsDetails) > 0) DO 
	  SET currrentResourceGroupTag = CAST(SUBSTR(resourceGroupsDetails, 1, (LOCATE('</-/>', resourceGroupsDetails) -1)) AS VARCHAR(255));
    
    INSERT INTO DB2INST1.RESOURCE_GROUP_TAGS (RESOURCEGROUPUUID, TAG)
    VALUES (newResourceGroupId, currrentResourceGroupTag);

    SET resourceGroupsDetails = SUBSTR(resourceGroupsDetails, (LOCATE('</-/>', resourceGroupsDetails) + 5));

  END WHILE;

  -- extract and insert the last tag not captured by the loop above
	SET currrentResourceGroupTag = CAST(SUBSTR(resourceGroupsDetails, 1, (LOCATE('</*/>', resourceGroupsDetails) -1)) AS VARCHAR(255));


  IF currrentResourceGroupTag <> '' THEN
    INSERT INTO RESOURCE_GROUP_TAGS (RESOURCEGROUPUUID, TAG)
    VALUES (newResourceGroupId, currrentResourceGroupTag);
  END IF;

  -- remove the last tag from the details string
	SET resourceGroupsDetails = SUBSTR(resourceGroupsDetails, (LOCATE('</*/>', resourceGroupsDetails) + 5));

  -- iterate through the entity types in the details
	WHILE (LOCATE('</+/>', resourceGroupsDetails) > 0) DO 
		SET currrentResourceGroupEntityType = CAST(SUBSTR(resourceGroupsDetails, 1, (LOCATE('</+/>', resourceGroupsDetails) -1)) AS VARCHAR(255));


    INSERT INTO DB2INST1.RESOURCE_GROUP_ENTITYTYPES (RESOURCEGROUPUUID, ENTITYTYPE)
    VALUES (newResourceGroupId, currrentResourceGroupEntityType);

    SET resourceGroupsDetails = SUBSTR(resourceGroupsDetails, (LOCATE('</+/>', resourceGroupsDetails) + 5));

  END WHILE;

  -- insert the last entity type not captured by the loop above
	IF resourceGroupsDetails <> '' THEN
		INSERT INTO DB2INST1.RESOURCE_GROUP_ENTITYTYPES (RESOURCEGROUPUUID, ENTITYTYPE)
    VALUES (newResourceGroupId, resourceGroupsDetails);
  END IF;

END@


CREATE PROCEDURE ALERTS_RELATIONS_UPDATE(IN inContextAlertUuid VARCHAR(255), IN resourceGroupIdsToAssociate CLOB, IN resourceGroupDetailsToAssociate CLOB)
LANGUAGE SQL
MODIFIES SQL DATA
BEGIN
	DECLARE currentResourceGroupId VARCHAR(255);
  DECLARE currentResourceGroupsDetails CLOB;
  DECLARE currentResourceGroupExists INTEGER;

  DELETE 
  FROM DB2INST1.ALERTS_RESOURCE_GROUPS_RELATIONS
  WHERE ALERTUUID = inContextAlertUuid;
  
  WHILE (LOCATE(',', resourceGroupIdsToAssociate) > 0) DO 
	  SET currentResourceGroupId = CAST(SUBSTR(resourceGroupIdsToAssociate, 1, (LOCATE(',', resourceGroupIdsToAssociate) -1)) AS VARCHAR(255));
    SET currentResourceGroupsDetails = SUBSTR(resourceGroupDetailsToAssociate, 1, (LOCATE('</=/>', resourceGroupDetailsToAssociate) -1));

    SET currentResourceGroupExists = (
      SELECT COUNT(UUID)
      FROM RESOURCE_GROUPS
      WHERE UUID = currentResourceGroupId
		);

    IF currentResourceGroupExists < 1 THEN 
			CALL DB2INST1.PROCESS_ALERT_RESOURCE_GROUP(currentResourceGroupId, currentResourceGroupsDetails);

    END IF;

    INSERT INTO DB2INST1.ALERTS_RESOURCE_GROUPS_RELATIONS (ALERTUUID, RESOURCEGROUPID) VALUES (inContextAlertUuid, currentResourceGroupId);

    SET resourceGroupIdsToAssociate = SUBSTR(resourceGroupIdsToAssociate, (LOCATE(',', resourceGroupIdsToAssociate) + 1));
    SET resourceGroupDetailsToAssociate = SUBSTR(resourceGroupDetailsToAssociate, (LOCATE('</=/>', resourceGroupDetailsToAssociate) + 5));

  END WHILE;

  SET currentResourceGroupExists = (
    SELECT COUNT(UUID)
    FROM DB2INST1.RESOURCE_GROUPS
    WHERE UUID = resourceGroupIdsToAssociate
  );


  IF currentResourceGroupExists < 1 THEN 
    CALL DB2INST1.PROCESS_ALERT_RESOURCE_GROUP(resourceGroupIdsToAssociate, resourceGroupDetailsToAssociate);
    
  END IF;

  INSERT INTO DB2INST1.ALERTS_RESOURCE_GROUPS_RELATIONS (ALERTUUID, RESOURCEGROUPID) VALUES (inContextAlertUuid, resourceGroupIdsToAssociate);

END@


-------------------------------
-- DDL Statements for Triggers
-------------------------------


CREATE TRIGGER CREATE_ALERTS_TO_RESOURCE_GROUPS_TRIGGER
AFTER INSERT ON DB2INST1.ALERTS_REPORTER_STATUS
REFERENCING NEW AS N
FOR EACH ROW
WHEN (N.RESOURCEGROUPIDS <> '')
BEGIN ATOMIC
  CALL DB2INST1.ALERTS_RELATIONS_UPDATE(N.UUID, N.RESOURCEGROUPIDS, N.RESOURCEGROUPDETAILS);
END@


CREATE TRIGGER CREATE_INCIDENTS_TO_ALERTS_TRIGGER
AFTER INSERT ON DB2INST1.INCIDENTS_REPORTER_STATUS
REFERENCING NEW AS N
FOR EACH ROW
BEGIN ATOMIC
	CALL DB2INST1.INCIDENTS_RELATIONS_UPDATE(N.TENANTID, N.UUID, N.ALERTIDS);
END@


CREATE TRIGGER UPDATE_ALERTS_TO_RESOURCE_GROUPS_TRIGGER
AFTER UPDATE ON DB2INST1.ALERTS_REPORTER_STATUS
REFERENCING NEW AS N OLD AS O
FOR EACH ROW
WHEN ( O.RESOURCEGROUPIDS <> N.RESOURCEGROUPIDS )
BEGIN ATOMIC
  CALL DB2INST1.ALERTS_RELATIONS_UPDATE(N.UUID, N.RESOURCEGROUPIDS, N.RESOURCEGROUPDETAILS);
END@


CREATE TRIGGER UPDATE_INCIDENTS_TO_ALERTS_TRIGGER
AFTER UPDATE ON DB2INST1.INCIDENTS_REPORTER_STATUS
REFERENCING NEW AS N OLD AS O
FOR EACH ROW
WHEN ( O.ALERTIDS <> N.ALERTIDS )
BEGIN ATOMIC
  CALL DB2INST1.INCIDENTS_RELATIONS_UPDATE(N.TENANTID, N.UUID, N.ALERTIDS);
END@

COMMIT WORK@


CREATE OR REPLACE VIEW INCIDENT_ALERT_RESOURCE_GROUP_IDS AS
SELECT
    ALERTS_RESOURCE_GROUPS_RELATIONS.RESOURCEGROUPID,
    INCIDENTS_ALERTS_RELATIONS.ALERTUUID AS ALERTID,
    INCIDENTS_ALERTS_RELATIONS.INCIDENTUUID AS INCIDENTID
FROM
    INCIDENTS_ALERTS_RELATIONS
LEFT JOIN ALERTS_RESOURCE_GROUPS_RELATIONS ON
    INCIDENTS_ALERTS_RELATIONS.ALERTUUID = ALERTS_RESOURCE_GROUPS_RELATIONS.ALERTUUID@





CREATE OR REPLACE VIEW RELATIVE_DAYS AS
SELECT
    DATE_TRUNC('day', ADD_DAYS(CURRENT_TIMESTAMP - CURRENT_TIMEZONE , - DAY)) AS RELATIVE_DAY,
    ID
FROM
    PAST_DAYS@


CREATE OR REPLACE VIEW RELATIVE_HOURS AS
SELECT
    DATE_TRUNC('hour', ADD_HOURS(CURRENT_TIMESTAMP - CURRENT_TIMEZONE, - HOUR)) AS RELATIVE_HOUR,
    ID
FROM
    PAST_HOURS@











CREATE OR REPLACE VIEW INCIDENT_ACTIVTY_BY_PRIORITY_LAST_24_HOURS_VW AS WITH RELEVANT_INCIDENTS AS (
SELECT
    UUID,
    PRIORITY,
    LASTCHANGEDTIME,
    CREATEDTIME,
    STATE
FROM
    INCIDENTS_REPORTER_STATUS
WHERE
	(
		CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
    	AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	) OR (
    	STATE = 'closed' 
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE 
    ) OR (
    	CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
    )
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.LASTCHANGEDTIME,
	    RELEVANT_INCIDENTS.CREATEDTIME,
        RELEVANT_INCIDENTS.STATE
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0')  AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.LASTCHANGEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.STATE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
), 
PRIORITY AS (
	-- CTE with incident priorities and associated priority names.
	SELECT
	    PRIORITY,
	    NAME
	FROM
	    INCIDENT_PRIORITY_TYPES 
),
UNIQUE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID
),
UNIQUE_GROUPS_IN_PRIORITIES AS (
	-- CTE that combines all permutations of priorities and resource group scope ids.
	SELECT
	    UNIQUE_GROUPS.RESOURCEGROUPSCOPEID,
	    PRIORITY.PRIORITY,
	    PRIORITY.NAME
	FROM
	    UNIQUE_GROUPS
	CROSS JOIN PRIORITY
	ORDER BY
	    PRIORITY.PRIORITY ASC 
),
NEWLY_OPEN AS (
	-- CTE that via grouping sets returns the incidents counts for newly opened incidents in 
	-- the time window segmented via resource group scope ids and priority or just the priority. 
	-- If the result set is segmented only by the incident priority then resulting 
	-- resource group scope id will be null, in which case the value is coalesced to be 'All Resources'
	-- and captures all opened incidents under this synthetic resource group.
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
	    AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
),
NEWLY_CLOSED AS (
	-- CTE that works same way as above except filtering for incidents that have been closed in the 
	-- selected time window.
	SELECT
	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
		 	STATE = 'closed'
	    AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
	    AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
),
PREVIOUSLY_OPEN AS (
	-- CTE that works same way as above except it looks for any incidents that have been
	-- opened prior to the time window and have been closed within the time window or 
	-- still remain open.
	SELECT
	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
		INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
		CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
    	AND (LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1) OR STATE != 'closed')
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
)
-- The final output that combines the above CTEs to show their respective counts for the 
-- possible permutions resource group scope ids and priorities.
SELECT
    PREVIOUSLY_OPEN.INCIDENTCOUNT AS PREVIOUSLY_OPEN,
    COALESCE(NEWLY_CLOSED.INCIDENTCOUNT, 0) AS NEWLY_CLOSED,
    NEWLY_OPEN.INCIDENTCOUNT AS NEWLY_OPEN,
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY,
    UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID
FROM
	UNIQUE_GROUPS_IN_PRIORITIES
LEFT JOIN NEWLY_CLOSED ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
LEFT JOIN PREVIOUSLY_OPEN ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = PREVIOUSLY_OPEN.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPEN.RESOURCEGROUPSCOPEID
LEFT JOIN NEWLY_OPEN ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_ACTIVTY_BY_PRIORITY_LAST_24_HOURS AS (
	SELECT
	    *
	FROM
	    INCIDENT_ACTIVTY_BY_PRIORITY_LAST_24_HOURS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_ACTIVTY_BY_PRIORITY_LAST_24_HOURS@


CREATE OR REPLACE VIEW INCIDENT_ACTIVTY_BY_PRIORITY_LAST_30_DAYS_VW AS WITH RELEVANT_INCIDENTS AS (
SELECT
    UUID,
    PRIORITY,
    LASTCHANGEDTIME,
    CREATEDTIME,
    STATE
FROM
    INCIDENTS_REPORTER_STATUS
WHERE
	(
		CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
    	AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	) OR (
    	STATE = 'closed' 
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE 
    ) OR (
    	CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
    )
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.LASTCHANGEDTIME,
	    RELEVANT_INCIDENTS.CREATEDTIME,
        RELEVANT_INCIDENTS.STATE
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0')  AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.LASTCHANGEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.STATE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
), 
PRIORITY AS (
	-- CTE with incident priorities and associated priority names.
	SELECT
	    PRIORITY,
	    NAME
	FROM
	    INCIDENT_PRIORITY_TYPES 
),
UNIQUE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID
),
UNIQUE_GROUPS_IN_PRIORITIES AS (
	-- CTE that combines all permutations of priorities and resource group scope ids.
	SELECT
	    UNIQUE_GROUPS.RESOURCEGROUPSCOPEID,
	    PRIORITY.PRIORITY,
	    PRIORITY.NAME
	FROM
	    UNIQUE_GROUPS
	CROSS JOIN PRIORITY
	ORDER BY
	    PRIORITY.PRIORITY ASC 
),
NEWLY_OPEN AS (
	-- CTE that via grouping sets returns the incidents counts for newly opened incidents in 
	-- the time window segmented via resource group scope ids and priority or just the priority. 
	-- If the result set is segmented only by the incident priority then resulting 
	-- resource group scope id will be null, in which case the value is coalesced to be 'All Resources'
	-- and captures all opened incidents under this synthetic resource group.
	SELECT
	    	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
	    AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
),
NEWLY_CLOSED AS (
	-- CTE that works same way as above except filtering for incidents that have been closed in the 
	-- selected time window.
	SELECT
	    	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
		 	STATE = 'closed'
	    AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
	    AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
),
PREVIOUSLY_OPEN AS (
	-- CTE that works same way as above except it looks for any incidents that have been
	-- opened prior to the time window and have been closed within the time window or 
	-- still remain open.
	SELECT
	    	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
		INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
		CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
    	AND (LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30) OR STATE != 'closed')
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
)
-- The final output that combines the above CTEs to show their respective counts for the 
-- possible permutions resource group scope ids and priorities.
SELECT
    PREVIOUSLY_OPEN.INCIDENTCOUNT AS PREVIOUSLY_OPEN,
    COALESCE(NEWLY_CLOSED.INCIDENTCOUNT, 0) AS NEWLY_CLOSED,
    NEWLY_OPEN.INCIDENTCOUNT AS NEWLY_OPEN,
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY,
    UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID
FROM
	UNIQUE_GROUPS_IN_PRIORITIES
LEFT JOIN NEWLY_CLOSED ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
LEFT JOIN PREVIOUSLY_OPEN ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = PREVIOUSLY_OPEN.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPEN.RESOURCEGROUPSCOPEID
LEFT JOIN NEWLY_OPEN ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_ACTIVTY_BY_PRIORITY_LAST_30_DAYS AS (
SELECT
    *
FROM
    INCIDENT_ACTIVTY_BY_PRIORITY_LAST_30_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_ACTIVTY_BY_PRIORITY_LAST_30_DAYS@


CREATE OR REPLACE VIEW INCIDENT_ACTIVTY_BY_PRIORITY_LAST_7_DAYS_VW AS WITH RELEVANT_INCIDENTS AS (
SELECT
    UUID,
    PRIORITY,
    LASTCHANGEDTIME,
    CREATEDTIME,
    STATE
FROM
    INCIDENTS_REPORTER_STATUS
WHERE
	(
		CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
    	AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	) OR (
    	STATE = 'closed' 
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE 
    ) OR (
    	CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
    	AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
    )
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.LASTCHANGEDTIME,
	    RELEVANT_INCIDENTS.CREATEDTIME,
			RELEVANT_INCIDENTS.STATE
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0')  AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.LASTCHANGEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.STATE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
), 
PRIORITY AS (
	-- CTE with incident priorities and associated priority names.
	SELECT
	    PRIORITY,
	    NAME
	FROM
	    INCIDENT_PRIORITY_TYPES 
),
UNIQUE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID
),
UNIQUE_GROUPS_IN_PRIORITIES AS (
	-- CTE that combines all permutations of priorities and resource group scope ids.
	SELECT
	    UNIQUE_GROUPS.RESOURCEGROUPSCOPEID,
	    PRIORITY.PRIORITY,
	    PRIORITY.NAME
	FROM
	    UNIQUE_GROUPS
	CROSS JOIN PRIORITY
	ORDER BY
	    PRIORITY.PRIORITY ASC 
),
NEWLY_OPEN AS (
	-- CTE that via grouping sets returns the incidents counts for newly opened incidents in 
	-- the time window segmented via resource group scope ids and priority or just the priority. 
	-- If the result set is segmented only by the incident priority then resulting 
	-- resource group scope id will be null, in which case the value is coalesced to be 'All Resources'
	-- and captures all opened incidents under this synthetic resource group.
	SELECT
	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
	    AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
),
NEWLY_CLOSED AS (
	-- CTE that works same way as above except filtering for incidents that have been closed in the 
	-- selected time window.
	SELECT
	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
		 	STATE = 'closed'
	    AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
	    AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
),
PREVIOUSLY_OPEN AS (
	-- CTE that works same way as above except it looks for any incidents that have been
	-- opened prior to the time window and have been closed within the time window or 
	-- still remain open.
	SELECT
	    COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
		INCIDENTPRIORITY,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
		CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
    	AND (LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7) OR STATE != 'closed')
	GROUP BY GROUPING SETS (
		    (
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
						INCIDENTPRIORITY 
				)
	    )
)
-- The final output that combines the above CTEs to show their respective counts for the 
-- possible permutions resource group scope ids and priorities.
SELECT
    PREVIOUSLY_OPEN.INCIDENTCOUNT AS PREVIOUSLY_OPEN,
    COALESCE(NEWLY_CLOSED.INCIDENTCOUNT, 0) AS NEWLY_CLOSED,
    NEWLY_OPEN.INCIDENTCOUNT AS NEWLY_OPEN,
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY,
    UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID
FROM
	UNIQUE_GROUPS_IN_PRIORITIES
LEFT JOIN NEWLY_CLOSED ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
LEFT JOIN PREVIOUSLY_OPEN ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = PREVIOUSLY_OPEN.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPEN.RESOURCEGROUPSCOPEID
LEFT JOIN NEWLY_OPEN ON
    UNIQUE_GROUPS_IN_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_IN_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_ACTIVTY_BY_PRIORITY_LAST_7_DAYS AS (
SELECT
    *
FROM
    INCIDENT_ACTIVTY_BY_PRIORITY_LAST_7_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_ACTIVTY_BY_PRIORITY_LAST_7_DAYS@


CREATE OR REPLACE VIEW INCIDENT_ACTIVTY_BY_TIME_LAST_24_HOURS_VW AS WITH RELEVANT_INCIDENTS AS (
	SELECT
	    UUID,
	    PRIORITY,
	    LASTCHANGEDTIME,
	    CREATEDTIME,
	    STATE
	FROM
	    INCIDENTS_REPORTER_STATUS
	WHERE
	    ( 
				CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)
	      AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE 
			) OR ( 
				STATE = 'closed'
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
			) OR (
				CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1) 
			) 
),
RELEVANT_INCIDENTS_WITH_STATE_CHANGES AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.CREATEDTIME,
	    INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME AS RESOLVEDTIME
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_AUDIT_STATE ON
	    RELEVANT_INCIDENTS.UUID = INCIDENTS_AUDIT_STATE.UUID
	WHERE
	    INCIDENTS_AUDIT_STATE.STATE = 'resolved'
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.PRIORITY,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.RESOLVEDTIME,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.CREATEDTIME
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS_WITH_STATE_CHANGES ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID 
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0') AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOLVEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
HOURS AS (
	SELECT
	    RELATIVE_HOUR
	FROM
	    RELATIVE_HOURS 
),
PRIORITY AS (
	SELECT
	    PRIORITY,
	    NAME
	FROM
	    INCIDENT_PRIORITY_TYPES 
),
HOURS_BY_PRIORITY AS (
	SELECT
	    HOURS.RELATIVE_HOUR AS MATCHED_DATE,
	    PRIORITY.PRIORITY
	FROM
	    HOURS
	CROSS JOIN PRIORITY 
),
SCOPE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID
 ),
SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES AS (
	SELECT
	    SCOPE_GROUPS.RESOURCEGROUPSCOPEID,
	    HOURS_BY_PRIORITY.MATCHED_DATE,
	    HOURS_BY_PRIORITY.PRIORITY
	FROM
	    SCOPE_GROUPS
	CROSS JOIN HOURS_BY_PRIORITY
	ORDER BY
	    HOURS_BY_PRIORITY.MATCHED_DATE ASC 
),
NEWLY_OPEN AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('hours', CREATEDTIME - CURRENT_TIMEZONE) AS INCIDENTCREATEDTIMEBYHOUR,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)
        AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		    	DATE_TRUNC('hours', CREATEDTIME - CURRENT_TIMEZONE),
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
		    	DATE_TRUNC('hours', CREATEDTIME - CURRENT_TIMEZONE),
		        INCIDENTPRIORITY 
	        )
	    )
),
NEWLY_CLOSED AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('hours', RESOLVEDTIME - CURRENT_TIMEZONE) AS RESOLVEDTIMEBYHOUR,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
    	RESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)
        AND RESOLVEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
	    (
	    	DATE_TRUNC('hours', RESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	    	DATE_TRUNC('hours', RESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY 
        )
    )
),
PREVIOUSLY_OPENED_LPIT AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('hours', ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)) AS MATCHED_DATE,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
    	CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)
        AND (RESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -1)
            OR RESOLVEDTIME IS NULL)
 	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
PREVIOUSLY_OPENED AS (
	SELECT
	    PREVIOUSLY_OPENED_LPIT.INCIDENTCOUNT,
	    PREVIOUSLY_OPENED_LPIT.MATCHED_DATE,
	    PREVIOUSLY_OPENED_LPIT.INCIDENTPRIORITY,
	    PREVIOUSLY_OPENED_LPIT.RESOURCEGROUPSCOPEID
	FROM
	    PREVIOUSLY_OPENED_LPIT
	UNION ALL
	SELECT
	    SUM( ( COALESCE(PREVIOUSLY_OPENED_LPIT.INCIDENTCOUNT, 0) + COALESCE(NEWLY_OPEN.INCIDENTCOUNT, 0) ) - COALESCE(NEWLY_CLOSED.INCIDENTCOUNT, 0) ) OVER ( PARTITION BY SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	ORDER BY
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) AS INCIDENTCOUNT,
	    ADD_HOURS(SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE, 1) AS MATCHED_DATE,
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY AS INCIDENTPRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	FROM
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES
	LEFT JOIN NEWLY_OPEN ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_OPEN.INCIDENTCREATEDTIMEBYHOUR
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID
	LEFT JOIN NEWLY_CLOSED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_CLOSED.RESOLVEDTIMEBYHOUR
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
	LEFT JOIN PREVIOUSLY_OPENED_LPIT ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = PREVIOUSLY_OPENED_LPIT.MATCHED_DATE
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY = PREVIOUSLY_OPENED_LPIT.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPENED_LPIT.RESOURCEGROUPSCOPEID )
	SELECT
	    PREVIOUSLY_OPENED.INCIDENTCOUNT AS PREVIOUSLY_OPENED,
	    COALESCE(NEWLY_CLOSED.INCIDENTCOUNT , 0) AS NEWLY_CLOSED,
	    NEWLY_OPEN.INCIDENTCOUNT AS NEWLY_OPEN,
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE,
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	FROM
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES
	LEFT JOIN NEWLY_CLOSED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_CLOSED.RESOLVEDTIMEBYHOUR
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
	LEFT JOIN PREVIOUSLY_OPENED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = PREVIOUSLY_OPENED.MATCHED_DATE
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY = PREVIOUSLY_OPENED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPENED.RESOURCEGROUPSCOPEID
	LEFT JOIN NEWLY_OPEN ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_OPEN.INCIDENTCREATEDTIMEBYHOUR
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_HOURS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID@


CREATE TABLE INCIDENT_ACTIVTY_BY_TIME_LAST_24_HOURS AS (
SELECT
    *
FROM
    INCIDENT_ACTIVTY_BY_TIME_LAST_24_HOURS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_ACTIVTY_BY_TIME_LAST_24_HOURS@


CREATE OR REPLACE VIEW INCIDENT_ACTIVTY_BY_TIME_LAST_30_DAYS_VW AS WITH RELEVANT_INCIDENTS AS (
	SELECT
	    UUID,
	    PRIORITY,
	    LASTCHANGEDTIME,
	    CREATEDTIME,
	    STATE
	FROM
	    INCIDENTS_REPORTER_STATUS
	WHERE
	    ( 
				CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)
	      AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE 
			) OR ( 
				STATE = 'closed'
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
			) OR (
				CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30) 
			) 
),
RELEVANT_INCIDENTS_WITH_STATE_CHANGES AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.CREATEDTIME,
	    INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME AS RESOLVEDTIME
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_AUDIT_STATE ON
	    RELEVANT_INCIDENTS.UUID = INCIDENTS_AUDIT_STATE.UUID
	WHERE
	    INCIDENTS_AUDIT_STATE.STATE = 'resolved'
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.PRIORITY,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.RESOLVEDTIME,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.CREATEDTIME
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS_WITH_STATE_CHANGES ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID 
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0') AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOLVEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
DAYS AS (
	SELECT
	    RELATIVE_DAY
	FROM
	    RELATIVE_DAYS 
),
PRIORITY AS (
	SELECT
	    PRIORITY,
	    NAME
	FROM
	    INCIDENT_PRIORITY_TYPES 
),
DAYS_BY_PRIORITY AS (
	SELECT
	    DAYS.RELATIVE_DAY AS MATCHED_DATE,
	    PRIORITY.PRIORITY
	FROM
	    DAYS
	CROSS JOIN PRIORITY 
),
SCOPE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID
 ),
SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES AS (
	SELECT
	    SCOPE_GROUPS.RESOURCEGROUPSCOPEID,
	    DAYS_BY_PRIORITY.MATCHED_DATE,
	    DAYS_BY_PRIORITY.PRIORITY
	FROM
	    SCOPE_GROUPS
	CROSS JOIN DAYS_BY_PRIORITY
	ORDER BY
	    DAYS_BY_PRIORITY.MATCHED_DATE ASC 
),
NEWLY_OPEN AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('day', CREATEDTIME - CURRENT_TIMEZONE) AS INCIDENTCREATEDTIMEBYDAY,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)
        AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		    	DATE_TRUNC('day', CREATEDTIME - CURRENT_TIMEZONE),
					INCIDENTPRIORITY,
					RESOURCEGROUPSCOPEID
		    ),
		    (
		    	DATE_TRUNC('day', CREATEDTIME - CURRENT_TIMEZONE),
					INCIDENTPRIORITY 
				)
	    )
),
NEWLY_CLOSED AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('day', RESOLVEDTIME - CURRENT_TIMEZONE) AS RESOLVEDTIMEBYDAY,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
    	RESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)
        AND RESOLVEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
	    (
	    	DATE_TRUNC('day', RESOLVEDTIME - CURRENT_TIMEZONE),
				INCIDENTPRIORITY,
				RESOURCEGROUPSCOPEID
	    ),
	    (
	    	DATE_TRUNC('day', RESOLVEDTIME - CURRENT_TIMEZONE),
				INCIDENTPRIORITY 
			)
    )
),
PREVIOUSLY_OPENED_LPIT AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('day', ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)) AS MATCHED_DATE,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
    	CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)
        AND (RESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -30)
            OR RESOLVEDTIME IS NULL)
 	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
PREVIOUSLY_OPENED AS (
	SELECT
	    PREVIOUSLY_OPENED_LPIT.INCIDENTCOUNT,
	    PREVIOUSLY_OPENED_LPIT.MATCHED_DATE,
	    PREVIOUSLY_OPENED_LPIT.INCIDENTPRIORITY,
	    PREVIOUSLY_OPENED_LPIT.RESOURCEGROUPSCOPEID
	FROM
	    PREVIOUSLY_OPENED_LPIT
	UNION ALL
	SELECT
	    SUM( ( COALESCE(PREVIOUSLY_OPENED_LPIT.INCIDENTCOUNT, 0) + COALESCE(NEWLY_OPEN.INCIDENTCOUNT, 0) ) - COALESCE(NEWLY_CLOSED.INCIDENTCOUNT, 0) ) OVER ( PARTITION BY SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	ORDER BY
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) AS INCIDENTCOUNT,
	    ADD_DAYS(SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE, 1) AS MATCHED_DATE,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY AS INCIDENTPRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	FROM
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES
	LEFT JOIN NEWLY_OPEN ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_OPEN.INCIDENTCREATEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID
	LEFT JOIN NEWLY_CLOSED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_CLOSED.RESOLVEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
	LEFT JOIN PREVIOUSLY_OPENED_LPIT ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = PREVIOUSLY_OPENED_LPIT.MATCHED_DATE
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = PREVIOUSLY_OPENED_LPIT.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPENED_LPIT.RESOURCEGROUPSCOPEID )
	SELECT
	    PREVIOUSLY_OPENED.INCIDENTCOUNT AS PREVIOUSLY_OPENED,
	    COALESCE(NEWLY_CLOSED.INCIDENTCOUNT , 0) AS NEWLY_CLOSED,
	    NEWLY_OPEN.INCIDENTCOUNT AS NEWLY_OPEN,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	FROM
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES
	LEFT JOIN NEWLY_CLOSED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_CLOSED.RESOLVEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
	LEFT JOIN PREVIOUSLY_OPENED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = PREVIOUSLY_OPENED.MATCHED_DATE
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = PREVIOUSLY_OPENED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPENED.RESOURCEGROUPSCOPEID
	LEFT JOIN NEWLY_OPEN ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_OPEN.INCIDENTCREATEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_ACTIVTY_BY_TIME_LAST_30_DAYS AS (
SELECT
    *
FROM
    INCIDENT_ACTIVTY_BY_TIME_LAST_30_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_ACTIVTY_BY_TIME_LAST_30_DAYS@


CREATE OR REPLACE VIEW INCIDENT_ACTIVTY_BY_TIME_LAST_7_DAYS_VW AS WITH RELEVANT_INCIDENTS AS (
	SELECT
	    UUID,
	    PRIORITY,
	    LASTCHANGEDTIME,
	    CREATEDTIME,
	    STATE
	FROM
	    INCIDENTS_REPORTER_STATUS
	WHERE
	    ( 
				CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)
	      AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE 
			) OR ( 
				STATE = 'closed'
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
			) OR (
				CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)
				AND LASTCHANGEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7) 
			) 
),
RELEVANT_INCIDENTS_WITH_STATE_CHANGES AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.CREATEDTIME,
	    INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME AS RESOLVEDTIME
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_AUDIT_STATE ON
	    RELEVANT_INCIDENTS.UUID = INCIDENTS_AUDIT_STATE.UUID
	WHERE
	    INCIDENTS_AUDIT_STATE.STATE = 'resolved'
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.PRIORITY,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.RESOLVEDTIME,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.CREATEDTIME
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS_WITH_STATE_CHANGES ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID 
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0') AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOLVEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
DAYS AS (
	SELECT
	    RELATIVE_DAY
	FROM
	    RELATIVE_DAYS 
	WHERE ID < 9
),
PRIORITY AS (
	SELECT
	    PRIORITY,
	    NAME
	FROM
	    INCIDENT_PRIORITY_TYPES 
),
DAYS_BY_PRIORITY AS (
	SELECT
	    DAYS.RELATIVE_DAY AS MATCHED_DATE,
	    PRIORITY.PRIORITY
	FROM
	    DAYS
	CROSS JOIN PRIORITY 
),
SCOPE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID 
 ),
SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES AS (
	SELECT
	    SCOPE_GROUPS.RESOURCEGROUPSCOPEID,
	    DAYS_BY_PRIORITY.MATCHED_DATE,
	    DAYS_BY_PRIORITY.PRIORITY
	FROM
	    SCOPE_GROUPS
	CROSS JOIN DAYS_BY_PRIORITY
	ORDER BY
	    DAYS_BY_PRIORITY.MATCHED_DATE ASC 
),
NEWLY_OPEN AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('day', CREATEDTIME - CURRENT_TIMEZONE) AS INCIDENTCREATEDTIMEBYDAY,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)
        AND CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
		    (
		    	DATE_TRUNC('day', CREATEDTIME - CURRENT_TIMEZONE),
		        INCIDENTPRIORITY,
		        RESOURCEGROUPSCOPEID
		    ),
		    (
		    	DATE_TRUNC('day', CREATEDTIME - CURRENT_TIMEZONE),
		        INCIDENTPRIORITY 
	        )
	    )
),
NEWLY_CLOSED AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('day', RESOLVEDTIME - CURRENT_TIMEZONE) AS RESOLVEDTIMEBYDAY,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
    	RESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)
        AND RESOLVEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP  - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
	    (
	    	DATE_TRUNC('day', RESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	    	DATE_TRUNC('day', RESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY 
        )
    )
),
PREVIOUSLY_OPENED_LPIT AS (
	SELECT
			COUNT (DISTINCT INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC('day', ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)) AS MATCHED_DATE,
	    INCIDENTPRIORITY,
	   	COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
    	CREATEDTIME - CURRENT_TIMEZONE < ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)
        AND (RESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP  - CURRENT_TIMEZONE, -7)
            OR RESOLVEDTIME IS NULL)
 	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
PREVIOUSLY_OPENED AS (
	SELECT
	    PREVIOUSLY_OPENED_LPIT.INCIDENTCOUNT,
	    PREVIOUSLY_OPENED_LPIT.MATCHED_DATE,
	    PREVIOUSLY_OPENED_LPIT.INCIDENTPRIORITY,
	    PREVIOUSLY_OPENED_LPIT.RESOURCEGROUPSCOPEID
	FROM
	    PREVIOUSLY_OPENED_LPIT
	UNION ALL
	SELECT
	    SUM( ( COALESCE(PREVIOUSLY_OPENED_LPIT.INCIDENTCOUNT, 0) + COALESCE(NEWLY_OPEN.INCIDENTCOUNT, 0) ) - COALESCE(NEWLY_CLOSED.INCIDENTCOUNT, 0) ) OVER ( PARTITION BY SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	ORDER BY
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ) AS INCIDENTCOUNT,
	    ADD_DAYS(SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE, 1) AS MATCHED_DATE,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY AS INCIDENTPRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	FROM
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES
	LEFT JOIN NEWLY_OPEN ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_OPEN.INCIDENTCREATEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID
	LEFT JOIN NEWLY_CLOSED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_CLOSED.RESOLVEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
	LEFT JOIN PREVIOUSLY_OPENED_LPIT ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = PREVIOUSLY_OPENED_LPIT.MATCHED_DATE
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = PREVIOUSLY_OPENED_LPIT.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPENED_LPIT.RESOURCEGROUPSCOPEID )
	SELECT
	    PREVIOUSLY_OPENED.INCIDENTCOUNT AS PREVIOUSLY_OPENED,
	    COALESCE(NEWLY_CLOSED.INCIDENTCOUNT , 0) AS NEWLY_CLOSED,
	    NEWLY_OPEN.INCIDENTCOUNT AS NEWLY_OPEN,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY,
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID
	FROM
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES
	LEFT JOIN NEWLY_CLOSED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_CLOSED.RESOLVEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_CLOSED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_CLOSED.RESOURCEGROUPSCOPEID
	LEFT JOIN PREVIOUSLY_OPENED ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = PREVIOUSLY_OPENED.MATCHED_DATE
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = PREVIOUSLY_OPENED.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = PREVIOUSLY_OPENED.RESOURCEGROUPSCOPEID
	LEFT JOIN NEWLY_OPEN ON
	    SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.MATCHED_DATE = NEWLY_OPEN.INCIDENTCREATEDTIMEBYDAY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.PRIORITY = NEWLY_OPEN.INCIDENTPRIORITY
	    AND SCOPE_GROUPS_BY_TIME_WINDOW_DAYS_AND_INCIDENT_PRIORITIES.RESOURCEGROUPSCOPEID = NEWLY_OPEN.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_ACTIVTY_BY_TIME_LAST_7_DAYS AS (
SELECT
    *
FROM
    INCIDENT_ACTIVTY_BY_TIME_LAST_7_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_ACTIVTY_BY_TIME_LAST_7_DAYS@


CREATE OR REPLACE VIEW INCIDENT_HANDLING_METRICS_LAST_24_HOURS_VW AS WITH UNIQUE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID 
),
HOURS_AND_PRIORITIES AS (
	SELECT
	    RELATIVE_HOURS.RELATIVE_HOUR AS MATCHED_DATE,
	    INCIDENT_PRIORITY_TYPES.PRIORITY
	FROM
	    RELATIVE_HOURS
	CROSS JOIN INCIDENT_PRIORITY_TYPES 
),
UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES AS (
	SELECT
	    UNIQUE_GROUPS.RESOURCEGROUPSCOPEID,
	    HOURS_AND_PRIORITIES.MATCHED_DATE,
	    HOURS_AND_PRIORITIES.PRIORITY
	FROM
	    UNIQUE_GROUPS
	CROSS JOIN HOURS_AND_PRIORITIES
	ORDER BY
	    HOURS_AND_PRIORITIES.MATCHED_DATE ASC 
),
RELEVANT_INCIDENTS AS (
	SELECT 
		UUID,
		PRIORITY,
		CREATEDTIME
	FROM 
		INCIDENTS_REPORTER_STATUS
	WHERE
	    STATE != 'unassigned' 
),
RELEVANT_INCIDENTS_WITH_STATE_CHANGES AS (
	SELECT
		RELEVANT_INCIDENTS.UUID,
		RELEVANT_INCIDENTS.PRIORITY,
		RELEVANT_INCIDENTS.CREATEDTIME,
		MIN((CASE
		    WHEN INCIDENTS_AUDIT_STATE.STATE = 'resolved'
				THEN INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME
		    ELSE NULL
		END)) AS INCIDENTRESOLVEDTIME,
	    MIN((CASE
	        WHEN INCIDENTS_AUDIT_STATE.STATE = 'assignedToTeam' OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToIndividual'
				THEN INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME
		    ELSE NULL 
		END)) AS INCIDENTACKNOWLEDGEDTIME
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_AUDIT_STATE ON
	    RELEVANT_INCIDENTS.UUID = INCIDENTS_AUDIT_STATE.UUID
	WHERE
	    INCIDENTS_AUDIT_STATE.STATE = 'resolved'
	    OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToTeam'
	    OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToIndividual'
	GROUP BY 
	    RELEVANT_INCIDENTS.UUID, RELEVANT_INCIDENTS.PRIORITY, RELEVANT_INCIDENTS.CREATEDTIME
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.PRIORITY,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.CREATEDTIME,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.INCIDENTRESOLVEDTIME, 
	   	RELEVANT_INCIDENTS_WITH_STATE_CHANGES.INCIDENTACKNOWLEDGEDTIME
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS_WITH_STATE_CHANGES ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0')  AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME AS INCIDENTCREATEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.INCIDENTRESOLVEDTIME, 
	   	INCIDENTS_BY_RESOURCE_GROUPS.INCIDENTACKNOWLEDGEDTIME
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
AVERAGE_TIME_TO_REPAIR_LPIT AS (
	SELECT
	    COUNT (INCIDENTID) AS INCIDENTCOUNT,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    INCIDENTPRIORITY,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTRESOLVEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOREPAIR
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE < ADD_DAYS ( CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -1 )
	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT AS (
	SELECT
	    INCIDENTPRIORITY,
	    COUNT (INCIDENTID) AS INCIDENTCOUNT,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTACKNOWLEDGEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOACKNOWLEDGE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE < ADD_DAYS ( CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -1 )
	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_24_HOURS AS (
    SELECT
	    INCIDENTPRIORITY,
	    COUNT(INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC( 'hours', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE) AS ENDDATEBYHOUR,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTRESOLVEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOREPAIR
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS (CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -1 )
	        AND INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
	    (
	        DATE_TRUNC('hours', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
		    DATE_TRUNC('hours', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_24_HOURS AS (
	SELECT
	    INCIDENTPRIORITY,
	    COUNT(INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC( 'hours', INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE) AS ENDDATEBYHOUR,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTACKNOWLEDGEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOACKNOWLEDGE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE > ADD_DAYS (CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -1 )
	        AND INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
		GROUP BY DATE_TRUNC('hours', INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE), INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
)
SELECT
    COALESCE(SUM(AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_24_HOURS.TIMETOREPAIR) OVER ( PARTITION BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_REPAIR_LPIT.TIMETOREPAIR, 0 ) AS TIMETOREPAIRTOTAL,
    COALESCE(SUM(AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_24_HOURS.INCIDENTCOUNT) OVER ( PARTITION BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_REPAIR_LPIT.INCIDENTCOUNT, 0 ) AS TIMETOREPAIRCOUNT,
    COALESCE(SUM(AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_24_HOURS.TIMETOACKNOWLEDGE) OVER ( PARTITION BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.TIMETOACKNOWLEDGE, 0 ) AS TIMETOACKNOWLEDGETOTAL,
    COALESCE(SUM(AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_24_HOURS.INCIDENTCOUNT) OVER ( PARTITION BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.INCIDENTCOUNT, 0 ) AS TIMETOACKNOWLEDGECOUNT,
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.MATCHED_DATE,
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY,
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID
FROM
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES
LEFT JOIN AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_24_HOURS ON
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.MATCHED_DATE = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_24_HOURS.ENDDATEBYHOUR
    AND UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_24_HOURS.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_24_HOURS.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_24_HOURS ON
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.MATCHED_DATE = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_24_HOURS.ENDDATEBYHOUR
    AND UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_24_HOURS.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_24_HOURS.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_REPAIR_LPIT ON
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_REPAIR_LPIT.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_REPAIR_LPIT.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT ON
    UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_HOURS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_HANDLING_METRICS_LAST_24_HOURS AS (
SELECT
    *
FROM
    INCIDENT_HANDLING_METRICS_LAST_24_HOURS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_HANDLING_METRICS_LAST_24_HOURS@


CREATE OR REPLACE VIEW INCIDENT_HANDLING_METRICS_LAST_30_DAYS_VW AS WITH UNIQUE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID 
),
DAYS_AND_PRIORITIES AS (
	SELECT
	    RELATIVE_DAYS.RELATIVE_DAY AS MATCHED_DATE,
	    INCIDENT_PRIORITY_TYPES.PRIORITY
	FROM
	    RELATIVE_DAYS
	CROSS JOIN INCIDENT_PRIORITY_TYPES 
),
UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES AS (
	SELECT
	    UNIQUE_GROUPS.RESOURCEGROUPSCOPEID,
	    DAYS_AND_PRIORITIES.MATCHED_DATE,
	    DAYS_AND_PRIORITIES.PRIORITY
	FROM
	    UNIQUE_GROUPS
	CROSS JOIN DAYS_AND_PRIORITIES
	ORDER BY
	    DAYS_AND_PRIORITIES.MATCHED_DATE ASC 
 ),
RELEVANT_INCIDENTS AS (
	SELECT 
		UUID,
		PRIORITY,
		CREATEDTIME
	FROM 
		INCIDENTS_REPORTER_STATUS
	WHERE
		STATE != 'unassigned' 
),
RELEVANT_INCIDENTS_WITH_STATE_CHANGES AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.CREATEDTIME,
	    MIN((CASE
		    WHEN INCIDENTS_AUDIT_STATE.STATE = 'resolved'
				THEN INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME
		    ELSE NULL
			END)) AS INCIDENTRESOLVEDTIME,
	    MIN((CASE
	        WHEN INCIDENTS_AUDIT_STATE.STATE = 'assignedToTeam' OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToIndividual'
				THEN INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME
		    ELSE NULL 
	    END)) AS INCIDENTACKNOWLEDGEDTIME
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_AUDIT_STATE ON
	    RELEVANT_INCIDENTS.UUID = INCIDENTS_AUDIT_STATE.UUID
	WHERE
	    INCIDENTS_AUDIT_STATE.STATE = 'resolved'
	    OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToTeam'
	    OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToIndividual'
	GROUP BY 
	    RELEVANT_INCIDENTS.UUID, RELEVANT_INCIDENTS.PRIORITY, RELEVANT_INCIDENTS.CREATEDTIME
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.PRIORITY,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.CREATEDTIME,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.INCIDENTRESOLVEDTIME, 
	   	RELEVANT_INCIDENTS_WITH_STATE_CHANGES.INCIDENTACKNOWLEDGEDTIME
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS_WITH_STATE_CHANGES ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0')  AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME AS INCIDENTCREATEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.INCIDENTRESOLVEDTIME, 
	   	INCIDENTS_BY_RESOURCE_GROUPS.INCIDENTACKNOWLEDGEDTIME
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
AVERAGE_TIME_TO_REPAIR_LPIT AS (
	SELECT
	    COUNT (INCIDENTID) AS INCIDENTCOUNT,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    INCIDENTPRIORITY,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTRESOLVEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOREPAIR
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE < ADD_DAYS ( CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -31 )
	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT AS (
	SELECT
	    INCIDENTPRIORITY,
	    COUNT (INCIDENTID) AS INCIDENTCOUNT,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTACKNOWLEDGEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOACKNOWLEDGE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE < ADD_DAYS ( CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -31 )
	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_30_DAYS AS (
    SELECT
	    INCIDENTPRIORITY,
	    COUNT(INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC( 'day', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE) AS ENDDATEBYHOUR,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTRESOLVEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOREPAIR
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS (CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -31 )
	        AND INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
	    (
	        DATE_TRUNC('day', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
		    DATE_TRUNC('day', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_30_DAYS AS (
	SELECT
	    INCIDENTPRIORITY,
	    COUNT(INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC( 'day', INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE) AS ENDDATEBYHOUR,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTACKNOWLEDGEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOACKNOWLEDGE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE > ADD_DAYS (CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -31 )
	        AND INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
		GROUP BY DATE_TRUNC('day', INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE), INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
)
SELECT
    COALESCE(SUM(AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_30_DAYS.TIMETOREPAIR) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_REPAIR_LPIT.TIMETOREPAIR, 0 ) AS TIMETOREPAIRTOTAL,
    COALESCE(SUM(AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_30_DAYS.INCIDENTCOUNT) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_REPAIR_LPIT.INCIDENTCOUNT, 0 ) AS TIMETOREPAIRCOUNT,
    COALESCE(SUM(AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_30_DAYS.TIMETOACKNOWLEDGE) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.TIMETOACKNOWLEDGE, 0 ) AS TIMETOACKNOWLEDGETOTAL,
    COALESCE(SUM(AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_30_DAYS.INCIDENTCOUNT) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.INCIDENTCOUNT, 0 ) AS TIMETOACKNOWLEDGECOUNT,
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE,
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY,
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID
FROM
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES
LEFT JOIN AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_30_DAYS ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_30_DAYS.ENDDATEBYHOUR
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_30_DAYS.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_30_DAYS.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_30_DAYS ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_30_DAYS.ENDDATEBYHOUR
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_30_DAYS.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_30_DAYS.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_REPAIR_LPIT ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_REPAIR_LPIT.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_REPAIR_LPIT.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_HANDLING_METRICS_LAST_30_DAYS AS (
SELECT
    *
FROM
    INCIDENT_HANDLING_METRICS_LAST_30_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_HANDLING_METRICS_LAST_30_DAYS@


CREATE OR REPLACE VIEW INCIDENT_HANDLING_METRICS_LAST_7_DAYS_VW AS WITH UNIQUE_GROUPS AS (
	SELECT
	    SCOPEID AS RESOURCEGROUPSCOPEID
	FROM
	    RESOURCE_GROUP_SCOPES
	GROUP BY
	    SCOPEID 
),
DAYS_AND_PRIORITIES AS (
	SELECT
	    RELATIVE_DAYS.RELATIVE_DAY AS MATCHED_DATE,
	    INCIDENT_PRIORITY_TYPES.PRIORITY
	FROM
	    RELATIVE_DAYS
	CROSS JOIN INCIDENT_PRIORITY_TYPES 
	WHERE
    	RELATIVE_DAYS.ID < 9 
),
UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES AS (
	SELECT
	    UNIQUE_GROUPS.RESOURCEGROUPSCOPEID,
	    DAYS_AND_PRIORITIES.MATCHED_DATE,
	    DAYS_AND_PRIORITIES.PRIORITY
	FROM
	    UNIQUE_GROUPS
	CROSS JOIN DAYS_AND_PRIORITIES
	ORDER BY
	    DAYS_AND_PRIORITIES.MATCHED_DATE ASC 
 ),
RELEVANT_INCIDENTS AS (
	SELECT 
		UUID,
		PRIORITY,
		CREATEDTIME
	FROM 
		INCIDENTS_REPORTER_STATUS
	WHERE
	    STATE != 'unassigned' 
),
RELEVANT_INCIDENTS_WITH_STATE_CHANGES AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    RELEVANT_INCIDENTS.CREATEDTIME,
	    MIN((CASE
		    WHEN INCIDENTS_AUDIT_STATE.STATE = 'resolved'
				THEN INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME
		    ELSE NULL
		END)) AS INCIDENTRESOLVEDTIME,
	    MIN((CASE
	        WHEN INCIDENTS_AUDIT_STATE.STATE = 'assignedToTeam' OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToIndividual'
				THEN INCIDENTS_AUDIT_STATE.LASTCHANGEDTIME
		    ELSE NULL 
	    END)) AS INCIDENTACKNOWLEDGEDTIME
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_AUDIT_STATE ON
	    RELEVANT_INCIDENTS.UUID = INCIDENTS_AUDIT_STATE.UUID
	WHERE
	    INCIDENTS_AUDIT_STATE.STATE = 'resolved'
	    OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToTeam'
	    OR INCIDENTS_AUDIT_STATE.STATE = 'assignedToIndividual'
	GROUP BY 
	    RELEVANT_INCIDENTS.UUID, RELEVANT_INCIDENTS.PRIORITY, RELEVANT_INCIDENTS.CREATEDTIME
),
INCIDENTS_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.PRIORITY,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.CREATEDTIME,
	    RELEVANT_INCIDENTS_WITH_STATE_CHANGES.INCIDENTRESOLVEDTIME, 
	   	RELEVANT_INCIDENTS_WITH_STATE_CHANGES.INCIDENTACKNOWLEDGEDTIME
	FROM
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS
	RIGHT JOIN RELEVANT_INCIDENTS_WITH_STATE_CHANGES ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.INCIDENTID = RELEVANT_INCIDENTS_WITH_STATE_CHANGES.UUID
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENT_ALERT_RESOURCE_GROUP_IDS.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0')  AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_BY_RESOURCE_GROUPS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_BY_RESOURCE_GROUPS.UUID AS INCIDENTID,
	    INCIDENTS_BY_RESOURCE_GROUPS.CREATEDTIME AS INCIDENTCREATEDTIME,
	    INCIDENTS_BY_RESOURCE_GROUPS.INCIDENTRESOLVEDTIME, 
	   	INCIDENTS_BY_RESOURCE_GROUPS.INCIDENTACKNOWLEDGEDTIME
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
AVERAGE_TIME_TO_REPAIR_LPIT AS (
	SELECT
	    COUNT (INCIDENTID) AS INCIDENTCOUNT,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    INCIDENTPRIORITY,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTRESOLVEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOREPAIR
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE < ADD_DAYS ( CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -8 )
	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT AS (
	SELECT
	    INCIDENTPRIORITY,
	    COUNT (INCIDENTID) AS INCIDENTCOUNT,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTACKNOWLEDGEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOACKNOWLEDGE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE < ADD_DAYS ( CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -8 )
	GROUP BY GROUPING SETS (
	    (
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_7_DAYS AS (
    SELECT
	    INCIDENTPRIORITY,
	    COUNT(INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC( 'day', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE) AS ENDDATEBYHOUR,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTRESOLVEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOREPAIR
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE > ADD_DAYS (CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -8 )
	        AND INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
	GROUP BY GROUPING SETS (
	    (
	        DATE_TRUNC('day', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY,
	        RESOURCEGROUPSCOPEID
	    ),
	    (
		    DATE_TRUNC('day', INCIDENTRESOLVEDTIME - CURRENT_TIMEZONE),
	        INCIDENTPRIORITY 
        )
    )
),
AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_7_DAYS AS (
	SELECT
	    INCIDENTPRIORITY,
	    COUNT(INCIDENTID) AS INCIDENTCOUNT,
	    DATE_TRUNC( 'day', INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE) AS ENDDATEBYHOUR,
	    COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID,
	    SUM(CAST(TIMESTAMPDIFF( 4, CHAR(INCIDENTACKNOWLEDGEDTIME - INCIDENTCREATEDTIME)) AS DOUBLE)) AS TIMETOACKNOWLEDGE
	FROM
	    INCIDENTS_BY_RESOURCE_GROUPS_SCOPES
	WHERE
	    INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE > ADD_DAYS (CURRENT_TIMESTAMP - CURRENT_TIMEZONE,
	    -8 )
	        AND INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
		GROUP BY DATE_TRUNC('day', INCIDENTACKNOWLEDGEDTIME - CURRENT_TIMEZONE), INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
)
SELECT
    COALESCE(SUM(AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_7_DAYS.TIMETOREPAIR) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_REPAIR_LPIT.TIMETOREPAIR, 0 ) AS TIMETOREPAIRTOTAL,
    COALESCE(SUM(AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_7_DAYS.INCIDENTCOUNT) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_REPAIR_LPIT.INCIDENTCOUNT, 0 ) AS TIMETOREPAIRCOUNT,
    COALESCE(SUM(AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_7_DAYS.TIMETOACKNOWLEDGE) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.TIMETOACKNOWLEDGE, 0 ) AS TIMETOACKNOWLEDGETOTAL,
    COALESCE(SUM(AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_7_DAYS.INCIDENTCOUNT) OVER ( PARTITION BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY, UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID ORDER BY UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE ASC ROWS BETWEEN UNBOUNDED PRECEDING AND CURRENT ROW ), 0) + COALESCE(AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.INCIDENTCOUNT, 0 ) AS TIMETOACKNOWLEDGECOUNT,
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE,
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY,
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID
FROM
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES
LEFT JOIN AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_7_DAYS ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_7_DAYS.ENDDATEBYHOUR
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_7_DAYS.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_REPAIR_FOR_INCIDENTS_IN_LAST_7_DAYS.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_7_DAYS ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.MATCHED_DATE = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_7_DAYS.ENDDATEBYHOUR
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_7_DAYS.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_ACKNOWLEDGE_FOR_INCIDENTS_IN_LAST_7_DAYS.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_REPAIR_LPIT ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_REPAIR_LPIT.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_REPAIR_LPIT.RESOURCEGROUPSCOPEID
LEFT JOIN AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT ON
    UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.PRIORITY = AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.INCIDENTPRIORITY
    AND UNIQUE_GROUPS_BY_DAYS_AND_PRIORITIES.RESOURCEGROUPSCOPEID = AVERAGE_TIME_TO_ACKNOWLEDGE_LPIT.RESOURCEGROUPSCOPEID@

CREATE TABLE INCIDENT_HANDLING_METRICS_LAST_7_DAYS AS (
SELECT
    *
FROM
    INCIDENT_HANDLING_METRICS_LAST_7_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE INCIDENT_HANDLING_METRICS_LAST_7_DAYS@


CREATE OR REPLACE VIEW NOISE_REDUCTION_LAST_24_HOURS_VW AS WITH RELEVANT_INCIDENTS AS (
	SELECT 
	    INCIDENTS_REPORTER_STATUS.UUID,
	    INCIDENTS_REPORTER_STATUS.PRIORITY
	FROM 
		INCIDENTS_REPORTER_STATUS
	WHERE 
		INCIDENTS_REPORTER_STATUS.CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -1)
	    AND INCIDENTS_REPORTER_STATUS.CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
),	
INCIDENTS_AND_BELONGING_ALERTS AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    INCIDENTS_ALERTS_RELATIONS.ALERTUUID AS ALERTID
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_ALERTS_RELATIONS ON
	    RELEVANT_INCIDENTS.UUID  = INCIDENTS_ALERTS_RELATIONS.INCIDENTUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES AS (
	SELECT
	    ALERTS_RESOURCE_GROUPS_RELATIONS.RESOURCEGROUPID,
	    INCIDENTS_AND_BELONGING_ALERTS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS.UUID AS INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS.ALERTID,
	    ALERTS_REPORTER_STATUS.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS
	LEFT JOIN ALERTS_REPORTER_STATUS ON
	    INCIDENTS_AND_BELONGING_ALERTS.ALERTID = ALERTS_REPORTER_STATUS.UUID
	LEFT JOIN ALERTS_RESOURCE_GROUPS_RELATIONS ON
	    INCIDENTS_AND_BELONGING_ALERTS.ALERTID = ALERTS_RESOURCE_GROUPS_RELATIONS.ALERTUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.ALERTID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0') AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.ALERTID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
ALERTS_AND_EVENTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT
		ALERTID,
		MAX(EVENTCOUNT) AS EVENTCOUNT,
		INCIDENTPRIORITY,
		COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES
	GROUP BY GROUPING SETS ( 
		(ALERTID, INCIDENTPRIORITY, RESOURCEGROUPSCOPEID),
		(ALERTID, INCIDENTPRIORITY)
	)
),
ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT 
		COUNT(ALERTID) AS ALERT_COUNTS,
		SUM(EVENTCOUNT) AS EVENT_COUNTS,
		RESOURCEGROUPSCOPEID,
		INCIDENTPRIORITY
	FROM
		ALERTS_AND_EVENTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
	WHERE RESOURCEGROUPSCOPEID != '0'
	GROUP BY INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
),
INCIDENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT
		COUNT(DISTINCT INCIDENTID) AS INCIDENT_COUNTS,
		INCIDENTPRIORITY,
		RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES
	WHERE 
	    RESOURCEGROUPSCOPEID != '0'
	GROUP BY INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
	UNION ALL
	SELECT
		COUNT(UUID) AS INCIDENT_COUNTS,
		PRIORITY AS INCIDENTPRIORITY,
		'All Resources' AS RESOURCEGROUPSCOPEID
	FROM
		RELEVANT_INCIDENTS
	GROUP BY PRIORITY
)
SELECT
    'events' AS FROM,
    'alerts' AS TO,
    EVENT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
UNION ALL
SELECT
  	'alerts' AS FROM,
    'incidents' AS TO,
    ALERT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
UNION ALL
SELECT
    'incidents' AS FROM,
    'end' AS TO,
    INCIDENT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    INCIDENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES@

CREATE TABLE NOISE_REDUCTION_LAST_24_HOURS AS (
SELECT
    *
FROM
    NOISE_REDUCTION_LAST_24_HOURS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM
ENABLE QUERY OPTIMIZATION@

REFRESH TABLE NOISE_REDUCTION_LAST_24_HOURS@


CREATE OR REPLACE VIEW NOISE_REDUCTION_LAST_30_DAYS_VW AS WITH RELEVANT_INCIDENTS AS (
	SELECT 
	    INCIDENTS_REPORTER_STATUS.UUID,
	    INCIDENTS_REPORTER_STATUS.PRIORITY
	FROM 
		INCIDENTS_REPORTER_STATUS
	WHERE 
		INCIDENTS_REPORTER_STATUS.CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -30)
	    AND INCIDENTS_REPORTER_STATUS.CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
),	
INCIDENTS_AND_BELONGING_ALERTS AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    INCIDENTS_ALERTS_RELATIONS.ALERTUUID AS ALERTID
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_ALERTS_RELATIONS ON
	    RELEVANT_INCIDENTS.UUID  = INCIDENTS_ALERTS_RELATIONS.INCIDENTUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES AS (
	SELECT
	    ALERTS_RESOURCE_GROUPS_RELATIONS.RESOURCEGROUPID,
	    INCIDENTS_AND_BELONGING_ALERTS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS.UUID AS INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS.ALERTID,
	    ALERTS_REPORTER_STATUS.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS
	LEFT JOIN ALERTS_REPORTER_STATUS ON
	    INCIDENTS_AND_BELONGING_ALERTS.ALERTID = ALERTS_REPORTER_STATUS.UUID
	LEFT JOIN ALERTS_RESOURCE_GROUPS_RELATIONS ON
	    INCIDENTS_AND_BELONGING_ALERTS.ALERTID = ALERTS_RESOURCE_GROUPS_RELATIONS.ALERTUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.ALERTID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0') AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.ALERTID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
ALERTS_AND_EVENTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT
		ALERTID,
		MAX(EVENTCOUNT) AS EVENTCOUNT,
		INCIDENTPRIORITY,
		COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES
	GROUP BY GROUPING SETS ( 
		(ALERTID, INCIDENTPRIORITY, RESOURCEGROUPSCOPEID),
		(ALERTID, INCIDENTPRIORITY)
	)
),
ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT 
		COUNT(ALERTID) AS ALERT_COUNTS,
		SUM(EVENTCOUNT) AS EVENT_COUNTS,
		RESOURCEGROUPSCOPEID,
		INCIDENTPRIORITY
	FROM
		ALERTS_AND_EVENTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
	WHERE RESOURCEGROUPSCOPEID != '0'
	GROUP BY INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
),
INCIDENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT
		COUNT(DISTINCT INCIDENTID) AS INCIDENT_COUNTS,
		INCIDENTPRIORITY,
		RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES
	WHERE 
	    RESOURCEGROUPSCOPEID != '0'
	GROUP BY INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
	UNION ALL
	SELECT
		COUNT(UUID) AS INCIDENT_COUNTS,
		PRIORITY AS INCIDENTPRIORITY,
		'All Resources' AS RESOURCEGROUPSCOPEID
	FROM
		RELEVANT_INCIDENTS
	GROUP BY PRIORITY
)
SELECT
    'events' AS FROM,
    'alerts' AS TO,
    EVENT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
UNION ALL
SELECT
  	'alerts' AS FROM,
    'incidents' AS TO,
    ALERT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
UNION ALL
SELECT
    'incidents' AS FROM,
    'end' AS TO,
    INCIDENT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    INCIDENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES@



CREATE TABLE NOISE_REDUCTION_LAST_30_DAYS AS (
SELECT
    *
FROM
    NOISE_REDUCTION_LAST_30_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM@

REFRESH TABLE NOISE_REDUCTION_LAST_30_DAYS@


CREATE OR REPLACE VIEW NOISE_REDUCTION_LAST_7_DAYS_VW AS WITH RELEVANT_INCIDENTS AS (
	SELECT 
	    INCIDENTS_REPORTER_STATUS.UUID,
	    INCIDENTS_REPORTER_STATUS.PRIORITY
	FROM 
		INCIDENTS_REPORTER_STATUS
	WHERE 
		INCIDENTS_REPORTER_STATUS.CREATEDTIME - CURRENT_TIMEZONE > ADD_DAYS( CURRENT_TIMESTAMP - CURRENT_TIMEZONE, -7)
	    AND INCIDENTS_REPORTER_STATUS.CREATEDTIME - CURRENT_TIMEZONE < CURRENT_TIMESTAMP - CURRENT_TIMEZONE
),	
INCIDENTS_AND_BELONGING_ALERTS AS (
	SELECT
	    RELEVANT_INCIDENTS.UUID,
	    RELEVANT_INCIDENTS.PRIORITY,
	    INCIDENTS_ALERTS_RELATIONS.ALERTUUID AS ALERTID
	FROM
	    RELEVANT_INCIDENTS
	LEFT JOIN INCIDENTS_ALERTS_RELATIONS ON
	    RELEVANT_INCIDENTS.UUID  = INCIDENTS_ALERTS_RELATIONS.INCIDENTUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES AS (
	SELECT
	    ALERTS_RESOURCE_GROUPS_RELATIONS.RESOURCEGROUPID,
	    INCIDENTS_AND_BELONGING_ALERTS.PRIORITY AS INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS.UUID AS INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS.ALERTID,
	    ALERTS_REPORTER_STATUS.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS
	LEFT JOIN ALERTS_REPORTER_STATUS ON
	    INCIDENTS_AND_BELONGING_ALERTS.ALERTID = ALERTS_REPORTER_STATUS.UUID
	LEFT JOIN ALERTS_RESOURCE_GROUPS_RELATIONS ON
	    INCIDENTS_AND_BELONGING_ALERTS.ALERTID = ALERTS_RESOURCE_GROUPS_RELATIONS.ALERTUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS AS (
	SELECT
	    RESOURCE_GROUPS.NAME AS RESOURCEGROUPNAME,
	    RESOURCE_GROUP_TAGS.TAG AS RESOURCEGROUPTAG,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.ALERTID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES
	LEFT JOIN RESOURCE_GROUPS ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.RESOURCEGROUPID = RESOURCE_GROUPS.UUID
	LEFT JOIN RESOURCE_GROUP_TAGS ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES.RESOURCEGROUPID = RESOURCE_GROUP_TAGS.RESOURCEGROUPUUID
),
INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES AS (
	SELECT
	    COALESCE(RESOURCE_GROUP_SCOPES.SCOPEID, '0') AS RESOURCEGROUPSCOPEID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.INCIDENTPRIORITY,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.INCIDENTID,
	   	INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.ALERTID,
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.EVENTCOUNT
	FROM
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS
	LEFT JOIN RESOURCE_GROUP_SCOPES ON
	    INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.RESOURCEGROUPTAG = RESOURCE_GROUP_SCOPES.RESOURCEGROUPTAG
	    OR INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS.RESOURCEGROUPNAME = RESOURCE_GROUP_SCOPES.RESOURCEGROUPNAME
),
ALERTS_AND_EVENTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT
		ALERTID,
		MAX(EVENTCOUNT) AS EVENTCOUNT,
		INCIDENTPRIORITY,
		COALESCE(RESOURCEGROUPSCOPEID, 'All Resources') AS RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES
	GROUP BY GROUPING SETS ( 
		(ALERTID, INCIDENTPRIORITY, RESOURCEGROUPSCOPEID),
		(ALERTID, INCIDENTPRIORITY)
	)
),
ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT 
		COUNT(ALERTID) AS ALERT_COUNTS,
		SUM(EVENTCOUNT) AS EVENT_COUNTS,
		RESOURCEGROUPSCOPEID,
		INCIDENTPRIORITY
	FROM
		ALERTS_AND_EVENTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
	WHERE RESOURCEGROUPSCOPEID != '0'
	GROUP BY INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
),
INCIDENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES AS (
	SELECT
		COUNT(DISTINCT INCIDENTID) AS INCIDENT_COUNTS,
		INCIDENTPRIORITY,
		RESOURCEGROUPSCOPEID
	FROM
		INCIDENTS_AND_BELONGING_ALERTS_WITH_RESOURCES_BY_RESOURCE_GROUPS_SCOPES
	WHERE 
	    RESOURCEGROUPSCOPEID != '0'
	GROUP BY INCIDENTPRIORITY, RESOURCEGROUPSCOPEID
	UNION ALL
	SELECT
		COUNT(UUID) AS INCIDENT_COUNTS,
		PRIORITY AS INCIDENTPRIORITY,
		'All Resources' AS RESOURCEGROUPSCOPEID
	FROM
		RELEVANT_INCIDENTS
	GROUP BY PRIORITY
)
SELECT
    'events' AS FROM,
    'alerts' AS TO,
    EVENT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
UNION ALL
SELECT
  	'alerts' AS FROM,
    'incidents' AS TO,
    ALERT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    ALERTS_AND_EVENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES
UNION ALL
SELECT
    'incidents' AS FROM,
    'end' AS TO,
    INCIDENT_COUNTS AS WEIGHT,
    INCIDENTPRIORITY AS PRIORITY,
    RESOURCEGROUPSCOPEID
FROM
    INCIDENTS_COUNTS_BY_PRIORITY_AND_RESOURCE_GROUP_SCOPES@

CREATE TABLE NOISE_REDUCTION_LAST_7_DAYS AS (
SELECT
    *
FROM
    NOISE_REDUCTION_LAST_7_DAYS_VW
)
DATA INITIALLY DEFERRED
REFRESH DEFERRED
MAINTAINED BY SYSTEM
ENABLE QUERY OPTIMIZATION@

REFRESH TABLE NOISE_REDUCTION_LAST_7_DAYS@


CREATE TABLE MQT_REFRESH_TIME  (
	REFRESHTIME TIMESTAMP,
  ID VARCHAR(1) DEFAULT '1'
)@

INSERT INTO MQT_REFRESH_TIME (REFRESHTIME) VALUES (NULL)@

CREATE OR REPLACE PROCEDURE REFRESH_MQTS()
LANGUAGE SQL
MODIFIES SQL DATA
BEGIN
  DECLARE REFRESH_MQT_STATEMENT VARCHAR(1024);
  -- Refresh last 24 hours MQTs
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_ACTIVTY_BY_PRIORITY_LAST_24_HOURS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;

  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_ACTIVTY_BY_TIME_LAST_24_HOURS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;
  
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_HANDLING_METRICS_LAST_24_HOURS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;
    
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.NOISE_REDUCTION_LAST_24_HOURS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;

  -- Refresh last 7 days MQTs
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_ACTIVTY_BY_PRIORITY_LAST_7_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;

  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_ACTIVTY_BY_TIME_LAST_7_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;
  
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_HANDLING_METRICS_LAST_7_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;
    
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.NOISE_REDUCTION_LAST_7_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;
  
  -- Refresh last 30 days MQTs
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_ACTIVTY_BY_PRIORITY_LAST_30_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;

  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_ACTIVTY_BY_TIME_LAST_30_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;
  
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.INCIDENT_HANDLING_METRICS_LAST_30_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;
    
  SET REFRESH_MQT_STATEMENT = 'REFRESH TABLE DB2INST1.NOISE_REDUCTION_LAST_30_DAYS';
  EXECUTE IMMEDIATE REFRESH_MQT_STATEMENT;

  UPDATE DB2INST1.MQT_REFRESH_TIME
  SET REFRESHTIME = (CURRENT_TIMESTAMP - CURRENT_TIMEZONE)
  WHERE ID = '1';
END@

CALL SYSPROC.ADMIN_TASK_ADD (
  'REFRESH MQTS EVERY 60S',
  CURRENT_TIMESTAMP,
  NULL,
  NULL,
  '* * * * *',
  'DB2INST1',
  'REFRESH_MQTS',
  NULL,
  NULL,
  NULL 
)@

